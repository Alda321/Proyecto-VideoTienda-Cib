<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Venta</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, select, button { margin: 5px; padding: 5px; }
        table { border-collapse: collapse; margin-top: 10px; width: 100%; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<h2>Formulario de Venta</h2>

<form id="formVenta">
    <label>Fecha: <input type="datetime-local" name="fecha" required></label><br>

    <label>Cliente:
        <select name="clienteId" id="clienteSelect" required>
            <option value="">--Seleccione un cliente--</option>
        </select>
    </label><br>

    <h3>Detalles de Venta</h3>
    <table id="tablaDetalles">
        <thead>
        <tr>
            <th>Película</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
            <th>Acción</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button type="button" onclick="agregarDetalle()">Agregar Detalle</button><br><br>

    <label>Total: <input type="number" name="total" id="totalVenta" readonly></label><br><br>

    <button type="submit">Guardar Venta</button>
</form>

<script>
    let peliculas = [];
    let clientes = [];

    // Usuario y contraseña para autenticación básica
    const authHeader = 'Basic ' + btoa('admin:admin'); // cambia según tu usuario y contraseña

    // Cargar clientes y películas
    async function cargarDatos() {
        try {
            const clientesResp = await fetch('http://localhost:8080/api/clientes', {
                headers: { 'Authorization': authHeader }
            });
            clientes = await clientesResp.json();
            const clienteSelect = document.getElementById('clienteSelect');
            clientes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.nombre;
                clienteSelect.appendChild(opt);
            });

            const peliculasResp = await fetch('http://localhost:8080/api/peliculas', {
                headers: { 'Authorization': authHeader }
            });
            peliculas = await peliculasResp.json();
        } catch (err) {
            console.error("Error cargando clientes/películas:", err);
            alert("Error cargando datos. Revisa la consola.");
        }
    }

    // Agregar detalle
    function agregarDetalle() {
        const tbody = document.querySelector('#tablaDetalles tbody');
        const tr = document.createElement('tr');

        const peliculaOptions = peliculas.map(p => `<option value="${p.id}" data-precio="${p.precio}">${p.titulo}</option>`).join('');

        tr.innerHTML = `
            <td>
                <select name="pelicula" onchange="actualizarPrecio(this)" required>
                    <option value="">--Seleccione--</option>
                    ${peliculaOptions}
                </select>
            </td>
            <td><input type="number" name="cantidad" value="1" min="1" onchange="actualizarSubtotal(this)" required></td>
            <td><input type="number" name="precioUnitario" step="0.01" readonly></td>
            <td><input type="number" name="subtotal" step="0.01" readonly></td>
            <td><button type="button" onclick="eliminarFila(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    function eliminarFila(btn) {
        btn.closest('tr').remove();
        calcularTotal();
    }

    function actualizarPrecio(select) {
        const tr = select.closest('tr');
        const precioInput = tr.querySelector('input[name="precioUnitario"]');
        const subtotalInput = tr.querySelector('input[name="subtotal"]');
        const selectedOption = select.selectedOptions[0];
        const precio = parseFloat(selectedOption.dataset.precio || 0);
        precioInput.value = precio.toFixed(2);

        const cantidad = parseInt(tr.querySelector('input[name="cantidad"]').value);
        subtotalInput.value = (precio * cantidad).toFixed(2);
        calcularTotal();
    }

    function actualizarSubtotal(input) {
        const tr = input.closest('tr');
        const precio = parseFloat(tr.querySelector('input[name="precioUnitario"]').value);
        const subtotalInput = tr.querySelector('input[name="subtotal"]');
        subtotalInput.value = (precio * parseInt(input.value)).toFixed(2);
        calcularTotal();
    }

    function calcularTotal() {
        const subtotales = Array.from(document.querySelectorAll('input[name="subtotal"]'));
        const total = subtotales.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
        document.getElementById('totalVenta').value = total.toFixed(2);
    }

    document.getElementById('formVenta').addEventListener('submit', async function(e) {
        e.preventDefault();

        const fecha = e.target.fecha.value;
        const clienteId = parseInt(e.target.clienteId.value);

        const detalles = Array.from(document.querySelectorAll('#tablaDetalles tbody tr')).map(tr => {
            const peliculaSelect = tr.querySelector('select[name="pelicula"]');
            const peliculaId = parseInt(peliculaSelect.value);
            if (!peliculaId) throw new Error("Debe seleccionar una película en todos los detalles.");

            return {
                cantidad: parseInt(tr.querySelector('input[name="cantidad"]').value),
                precioUnitario: parseFloat(tr.querySelector('input[name="precioUnitario"]').value),
                pelicula: { id: peliculaId }
            };
        });

        const venta = {
            fecha,
            total: parseFloat(document.getElementById('totalVenta').value),
            cliente: { id: clienteId },
            detalles
        };

        try {
            const response = await fetch('http://localhost:8080/api/ventas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authHeader
                },
                body: JSON.stringify(venta)
            });

            if (!response.ok) throw new Error('Error al guardar la venta');

            alert('Venta registrada con éxito');
            e.target.reset();
            document.querySelector('#tablaDetalles tbody').innerHTML = '';
            document.getElementById('totalVenta').value = 0;
        } catch (err) {
            console.error(err);
            alert('No se pudo guardar la venta: ' + err.message);
        }
    });

    window.onload = cargarDatos;
</script>

</body>
</html>
