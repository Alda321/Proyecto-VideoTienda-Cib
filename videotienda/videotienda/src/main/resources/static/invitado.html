<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Películas Disponibles</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
          background: #f8f9fa;
        }
        .navbar-brand {
          font-weight: bold;
          letter-spacing: 1px;
        }
        .card {
          border-radius: 1rem;
          transition: transform 0.2s ease-in-out;
        }
        .card:hover {
          transform: scale(1.02);
        }
        .card img {
          border-top-left-radius: 1rem;
          border-top-right-radius: 1rem;
          height: 300px;
          object-fit: cover;
        }
        .btn-action {
          margin-right: 5px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Películas</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-4">
    <h2 class="mb-4 text-center">Cartelera</h2>
    <div id="listaPeliculas" class="row g-4"></div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiUrlPeliculas = "http://localhost:8080/api/peliculas";
    const authHeader = "Basic " + btoa("invitado:invitado"); // si usas autenticación

    async function cargarPeliculas() {
      try {
        const res = await fetch(apiUrlPeliculas, { headers: { "Authorization": authHeader } });
        const text = await res.text();
        const peliculas = text ? JSON.parse(text) : [];
        const contenedor = document.getElementById("listaPeliculas");
        contenedor.innerHTML = "";

        peliculas.forEach(p => {
          const col = document.createElement("div");
          col.className = "col-md-4";

          col.innerHTML = `
            <div class="card shadow h-100">
              <img src="${p.imagenUrl ?? 'https://via.placeholder.com/400x300?text=Sin+Imagen'}" class="card-img-top" alt="${p.titulo}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${p.titulo}</h5>
                <p class="card-text"><strong>Género:</strong> ${p.genero ? p.genero.nombre : "Sin género"}</p>
                <p class="card-text"><strong>Estreno:</strong> ${p.fechaEstreno ?? ""}</p>
                <div class="mt-auto d-flex justify-content-between">
                  <button class="btn btn-primary btn-action" onclick="comprar(${p.id})">Comprar</button>
                  <button class="btn btn-success" onclick="alquilar(${p.id})">Alquilar</button>
                </div>
              </div>
            </div>
          `;

          contenedor.appendChild(col);
        });
      } catch (err) {
        console.error(err);
        alert("Error cargando películas");
      }
    }

    function comprar(id, titulo, precio) {
  const venta = {
    fecha: new Date().toISOString().split("T")[0], // yyyy-MM-dd
    total: precio,
    cliente: { id: localStorage.getItem("clienteId") }, // suponiendo que guardas el id al loguear
    detalles: [
      {
        pelicula: { id: id },
        tipo: "COMPRA",
        precio: precio
      }
    ]
  };

  fetch("http://localhost:8080/api/ventas", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": authHeader
    },
    body: JSON.stringify(venta)
  })
    .then(res => {
      if (!res.ok) throw new Error("Error en la compra");
      return res.json();
    })
    .then(data => {
      alert("Compra exitosa de " + titulo);
    })
    .catch(err => {
      console.error(err);
      alert("Error al procesar la compra");
    });
}


    function alquilar(id, titulo, precio) {
  const venta = {
    fecha: new Date().toISOString().split("T")[0],
    total: precio * 0.5, // por ejemplo
    cliente: { id: localStorage.getItem("clienteId") },
    detalles: [
      {
        pelicula: { id: id },
        tipo: "ALQUILER",
        precio: precio * 0.5
      }
    ]
  };

  fetch("http://localhost:8080/api/ventas", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": authHeader
    },
    body: JSON.stringify(venta)
  })
    .then(res => {
      if (!res.ok) throw new Error("Error en el alquiler");
      return res.json();
    })
    .then(data => {
      alert("Alquiler exitoso de " + titulo);
    })
    .catch(err => {
      console.error(err);
      alert("Error al procesar el alquiler");
    });
}


    window.onload = cargarPeliculas;
</script>

</body>
</html>
