<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Venta</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0px 0px 15px rgba(0,0,0,0.1);
        }
        .table th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Gesti√≥n de Ventas</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav" aria-controls="navbarNav"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>

<div class="container mt-4">
    <div class="card p-4">
        <h2 class="mb-3 text-primary">Formulario de Venta</h2>

        <form id="formVenta">
            <div class="mb-3">
                <label class="form-label">Fecha</label>
                <input type="datetime-local" class="form-control" name="fecha" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Cliente</label>
                <select name="clienteId" id="clienteSelect" class="form-select" required>
                    <option value="">--Seleccione un cliente--</option>
                </select>
            </div>

            <h4 class="mt-4">Detalles de Venta</h4>
            <div class="table-responsive">
                <table class="table table-bordered mt-2" id="tablaDetalles">
                    <thead>
                    <tr>
                        <th>Pel√≠cula</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acci√≥n</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button type="button" class="btn btn-outline-primary mb-3" onclick="agregarDetalle()">‚ûï Agregar Detalle</button>

            <div class="mb-3">
                <label class="form-label">Total</label>
                <input type="number" class="form-control" name="total" id="totalVenta" readonly>
            </div>

            <button type="submit" class="btn btn-success">üíæ Guardar Venta</button>
            <a href="ventas.html" class="btn btn-secondary">‚¨Ö Volver</a>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let peliculas = [];
    let clientes = [];
    const authHeader = 'Basic ' + btoa('admin:admin');

    async function cargarDatos() {
        try {
            const clientesResp = await fetch('http://localhost:8080/api/clientes', {
                headers: { 'Authorization': authHeader }
            });
            clientes = await clientesResp.json();
            const clienteSelect = document.getElementById('clienteSelect');
            clientes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.nombre;
                clienteSelect.appendChild(opt);
            });

            const peliculasResp = await fetch('http://localhost:8080/api/peliculas', {
                headers: { 'Authorization': authHeader }
            });
            peliculas = await peliculasResp.json();
        } catch (err) {
            console.error("Error cargando clientes/pel√≠culas:", err);
            alert("Error cargando datos. Revisa la consola.");
        }
    }

    function agregarDetalle() {
        const tbody = document.querySelector('#tablaDetalles tbody');
        const tr = document.createElement('tr');

        const peliculaOptions = peliculas.map(p => `<option value="${p.id}" data-precio="${p.precio}">${p.titulo}</option>`).join('');

        tr.innerHTML = `
            <td>
                <select name="pelicula" class="form-select" onchange="actualizarPrecio(this)" required>
                    <option value="">--Seleccione--</option>
                    ${peliculaOptions}
                </select>
            </td>
            <td><input type="number" class="form-control" name="cantidad" value="1" min="1" onchange="actualizarSubtotal(this)" required></td>
            <td><input type="number" class="form-control" name="precioUnitario" step="0.01" readonly></td>
            <td><input type="number" class="form-control" name="subtotal" step="0.01" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">‚ùå</button></td>
        `;
        tbody.appendChild(tr);
    }

    function eliminarFila(btn) {
        btn.closest('tr').remove();
        calcularTotal();
    }

    function actualizarPrecio(select) {
        const tr = select.closest('tr');
        const precioInput = tr.querySelector('input[name="precioUnitario"]');
        const subtotalInput = tr.querySelector('input[name="subtotal"]');
        const selectedOption = select.selectedOptions[0];
        const precio = parseFloat(selectedOption.dataset.precio || 0);
        precioInput.value = precio.toFixed(2);

        const cantidad = parseInt(tr.querySelector('input[name="cantidad"]').value);
        subtotalInput.value = (precio * cantidad).toFixed(2);
        calcularTotal();
    }

    function actualizarSubtotal(input) {
        const tr = input.closest('tr');
        const precio = parseFloat(tr.querySelector('input[name="precioUnitario"]').value);
        const subtotalInput = tr.querySelector('input[name="subtotal"]');
        subtotalInput.value = (precio * parseInt(input.value)).toFixed(2);
        calcularTotal();
    }

    function calcularTotal() {
        const subtotales = Array.from(document.querySelectorAll('input[name="subtotal"]'));
        const total = subtotales.reduce((sum, s) => sum + parseFloat(s.value || 0), 0);
        document.getElementById('totalVenta').value = total.toFixed(2);
    }

    document.getElementById('formVenta').addEventListener('submit', async function(e) {
        e.preventDefault();

        const fecha = e.target.fecha.value;
        const clienteId = parseInt(e.target.clienteId.value);

        const detalles = Array.from(document.querySelectorAll('#tablaDetalles tbody tr')).map(tr => {
            const peliculaSelect = tr.querySelector('select[name="pelicula"]');
            const peliculaId = parseInt(peliculaSelect.value);
            if (!peliculaId) throw new Error("Debe seleccionar una pel√≠cula en todos los detalles.");

            return {
                cantidad: parseInt(tr.querySelector('input[name="cantidad"]').value),
                precioUnitario: parseFloat(tr.querySelector('input[name="precioUnitario"]').value),
                pelicula: { id: peliculaId }
            };
        });

        const venta = {
            fecha,
            total: parseFloat(document.getElementById('totalVenta').value),
            cliente: { id: clienteId },
            detalles
        };

        try {
            const response = await fetch('http://localhost:8080/api/ventas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authHeader
                },
                body: JSON.stringify(venta)
            });

            if (!response.ok) throw new Error('Error al guardar la venta');

            alert('‚úÖ Venta registrada con √©xito');
            e.target.reset();
            document.querySelector('#tablaDetalles tbody').innerHTML = '';
            document.getElementById('totalVenta').value = 0;
        } catch (err) {
            console.error(err);
            alert('‚ùå No se pudo guardar la venta: ' + err.message);
        }
    });

    window.onload = cargarDatos;
</script>

</body>
</html>
