<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Ventas</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a2e0e6ad67.js" crossorigin="anonymous"></script>
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Videotienda</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="peliculas.html">Películas</a></li>
                <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
                <li class="nav-item"><a class="nav-link" href="index.html">Regresar</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">

    <!-- TÍTULO -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">📊 Gestión de Ventas</h2>
        <p class="text-muted">Administra y consulta todas las ventas realizadas</p>
    </div>

    <!-- TABLA DE VENTAS -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            Listado de Ventas
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tablaVentas" class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Películas</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <a href="FormVentas.html" class="btn btn-primary mb-5">➕ Nueva Venta</a>
    <a href="index.html" class="btn btn-primary mb-5">⬅ Volver</a>

</div>

<script>
    const apiVentas = "http://localhost:8080/api/ventas";

    // Cargar ventas
    async function cargarVentas() {
      try {
        const res = await fetch(apiVentas);
        const text = await res.text();
        const ventas = text ? JSON.parse(text) : [];
        const tbody = document.querySelector("#tablaVentas tbody");
        tbody.innerHTML = "";

        ventas.forEach(v => {
          const tr = document.createElement("tr");
          const peliculas = v.detalles?.map(d => d.pelicula?.titulo).join(", ") || "Sin detalles";
          tr.innerHTML = `
            <td>${v.id}</td>
            <td>${v.cliente?.nombre || v.cliente || "Sin cliente"}</td>
            <td>${v.fecha ? v.fecha.split("T")[0] : ""}</td>
            <td>S/. ${v.total?.toFixed(2) || "0.00"}</td>
            <td>${peliculas}</td>
            <td class="text-center">
              <button class="btn btn-danger btn-sm" onclick="eliminarVenta(${v.id})">
                <i class="fas fa-trash">Eliminar</i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert("Error al cargar ventas");
      }
    }

    // Eliminar venta
    async function eliminarVenta(id) {
      if (!confirm("¿Eliminar esta venta?")) return;
      try {
        const res = await fetch(`${apiVentas}/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("Venta eliminada ✅");
          cargarVentas();
        } else {
          alert("Error al eliminar venta");
        }
      } catch (err) {
        console.error(err);
        alert("No se pudo eliminar la venta");
      }
    }

    window.onload = cargarVentas;
</script>

</body>
</html>
