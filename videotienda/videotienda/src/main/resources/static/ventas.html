<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Ventas</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a2e0e6ad67.js" crossorigin="anonymous"></script>
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Videotienda</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="peliculas.html">Películas</a></li>
                <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
                <li class="nav-item"><a class="nav-link" href="index.html">Regresar</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">

    <!-- TÍTULO -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">📊 Gestión de Ventas</h2>
        <p class="text-muted">Administra y consulta todas las ventas realizadas</p>
    </div>

    <!-- TABLA DE VENTAS -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            Listado de Ventas
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tablaVentas" class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Películas</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Cargar ventas aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <a href="nuevaVenta.html" class="btn btn-primary mb-3">➕ Nueva Venta</a>


    <!-- FORM NUEVA VENTA -->
    <div class="card shadow">
        <div class="card-header bg-success text-white fw-bold">
            Editar Venta
        </div>
        <div class="card-body">
            <form id="formVenta" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Cliente:</label>
                    <input type="text" id="cliente" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Total:</label>
                    <input type="number" step="0.01" id="total" class="form-control" required>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const apiVentas = "http://localhost:8080/api/ventas";

    // Cargar ventas
    async function cargarVentas() {
      try {
        const res = await fetch(apiVentas);
        const text = await res.text();
        const ventas = text ? JSON.parse(text) : [];
        const tbody = document.querySelector("#tablaVentas tbody");
        tbody.innerHTML = "";

        ventas.forEach(v => {
          const tr = document.createElement("tr");
          const peliculas = v.detalles?.map(d => d.pelicula?.titulo).join(", ") || "Sin detalles";
          tr.innerHTML = `
            <td>${v.id}</td>
            <td>${v.cliente?.nombre || v.cliente || "Sin cliente"}</td>
            <td>${v.fecha ? v.fecha.split("T")[0] : ""}</td>
            <td>S/. ${v.total?.toFixed(2) || "0.00"}</td>
            <td>${peliculas}</td>
            <td class="text-center">
              <button class="btn btn-warning btn-sm me-1" onclick="editarVenta(${v.id})">
                <i class="fas fa-edit">Editar</i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="eliminarVenta(${v.id})">
                <i class="fas fa-trash">Eliminar</i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert("Error al cargar ventas");
      }
    }

    // Guardar venta
    document.getElementById("formVenta").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = e.target.dataset.editing;
      const venta = {
        cliente: document.getElementById("cliente").value,
        total: parseFloat(document.getElementById("total").value),
        fecha: new Date().toISOString(),
        detalles: []
      };

      try {
        const res = await fetch(id ? `${apiVentas}/${id}` : apiVentas, {
          method: id ? "PUT" : "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(venta)
        });

        if (res.ok) {
          alert(id ? "Venta actualizada ✅" : "Venta creada ✅");
          e.target.reset();
          delete e.target.dataset.editing;
          cargarVentas();
        } else {
          alert("Error al guardar venta");
        }
      } catch (err) {
        console.error(err);
        alert("No se pudo guardar la venta");
      }
    });

    // Editar venta
    async function editarVenta(id) {
      try {
        const res = await fetch(`${apiVentas}/${id}`);
        if (res.ok) {
          const venta = await res.json();
          document.getElementById("cliente").value = venta.cliente?.nombre || venta.cliente || "";
          document.getElementById("total").value = venta.total || 0;
          document.getElementById("formVenta").dataset.editing = id;
        } else {
          alert("Venta no encontrada");
        }
      } catch (err) {
        console.error(err);
        alert("Error al cargar la venta");
      }
    }

    // Eliminar venta
    async function eliminarVenta(id) {
      if (!confirm("¿Eliminar esta venta?")) return;
      try {
        const res = await fetch(`${apiVentas}/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("Venta eliminada ✅");
          cargarVentas();
        } else {
          alert("Error al eliminar venta");
        }
      } catch (err) {
        console.error(err);
        alert("No se pudo eliminar la venta");
      }
    }

    window.onload = cargarVentas;
</script>

</body>
</html>
